# 1 基础使用

## 1.1 理论基础

### 1.1.1 基本概念

- 数据库（DB）：保存有组织的数据的容器（通常为一组文件）
- 数据库管理系统（DBMS）：存储、检索、管理和处理数据的软件。
- 表：数据库内的数据都是存在表中的，一个表是某种特定类型的数据的结构化清单
- 列：表是由一个或多个列组成的，每一列就是表的一个字段，并且每一列都有相应的数据类型
- 行：表中的数据都是按行存储的，每一行就是一个记录
> `MySQL`是一个DBMS而不是一个DB

### 1.1.2 文件结构

- `.frm` ：表结构文件
- `.myd` : `MYISAM`数据引擎的表数据文件
- `.myi` : `MYISAM`数据引擎的表索引文件
- `.idb` ：`innodb`引擎的表数据、索引等数据文件

### 1.1.3 数据类型

#### I. 文本类型



#### II. 数值类型



#### III. 日期时间类型

`Mysql`中有一组专门的日期时间类型，这些日期类型是符合特殊格式的时间字符串，格式为`YYYY-MM-DD HH:MM:SS`，并且有一个合法的范围，超过范围时变为`null`。

- `DATE` ：格式为`YYYY-MM-DD`，范围`1000-01-01～9999-12-31`
- `TIME` ：格式为`HH:MM:SS`，范围`00:00:00~11:59:59`
- `DATETIME` : `DATE` 和`TIME`的结合，占8字节
- `TIMESTAMP` ： 时间戳，占4字节，按GMT时间（0时区）为标准`1970-01-01 00:00:00`到某个时间点的秒数，`MySql`会自动将时间戳根据不同时区转换成标准格式`YYYY-MM-DD HH:MM:SS`

## 1.2 连接数据库与查看数据库信息

### 1.2.1 连接数据库

- 命令：mysql
- 参数：-u 用户 -p 口令 -h 主机 -P 端口

### 1.2.2 选择使用的数据库

- 命令：use
- 参数：数据库名

### 1.2.3查看数据库信息

- 命令：show
- 参数：
    - databases：显示DBMS管理的所有数据库
    - tables：显示当前数据库内的表
    - columns from 表：显示表的所有列
    - status：显示服务器状态信息
    - grants：显示授权用户的安全授权
    - errors/warning：显示错误或警告信息


## 1.3 检索数据

检索数据使用SELECT命令，SELECT命令后面跟查询的列，并且使用FROM子句指定表名。

```Sql
SELECT colu1,colu2
FROM tables;
```

### 1.3.1 数据过滤

通过SELECT检索的数据往往是冗余的，需要经过过滤与处理才能有效地使用。数据过滤使用WHERE子句实现。

```Sql
SELECT colu1,colu2
FROM tables
WHERE conditions;
```

> WHERE关键字后的conditions称为过滤条件

#### I. 单个普通过滤条件

使用一个表达式来作为过滤条件
```sql
SELECT colu1,colu2
FROM tables
WHERE colu1 = 1.0;
```
其中条件判断有如下几种：
- 等于： = 
- 不等于 ： <> / !=
- 大于/大于等于：> / >=
- 小于/小于等于：< / <=
- 在两个值之间：BETWEEN n AND m
- 检查空值：IS NULL
- 是否在集合中：IN (元素1,元素2,……元素n)
- 表示否定：NOT
- 满足通配：LIKE 搜索模式
- 满足正则：REGEXP 正则模式

#### II. 多个过滤条件

使用AND和OR连接过滤条件，其中AND的优先级大于OR
```sql
SELECT colu1,colu2
FROM tables
WHERE colu1 = 1.0 AND colu2 = 2.0;
```
#### III. 通配符过滤条件

使用LIKE操作符来使用搜索模式（通配符和字面值组成的表达式）来匹配数据。

```sql
SELECT colu1,colu2
FROM tables
WHERE colu1 LIKE 'abc%';
```
通配符
- % ：任意个任意字符 
- _ ：一个任意字符

> 'abc%' 代表以abc开头的字符串；'abc_'代表以abc开头的4个字符的字符串

#### IV. 正则搜索

使用LIKE与搜索模式来匹配数据，可以满足大多基础的数据搜索，但一些更复杂的情景下，可以使用正则表达式来完成任务。

正则表达式也称为模式，与搜索模式类似，它是由字面量和正则通配符组成，一旦文本满足正则模式，则返回该列。

>  通配符查找和正则查找很相似，很多情况下都可以相互转换，它们最重要的区别在于：通配符组成的搜索模式需要匹配该列值的全部内容，即该列的值要完全满足搜索模式。而正则查找则只需要该列值里的部分文本满足正则模式即可。
>也就是说LIKE匹配整个串，而REGEXP匹配子串

（1）常用特殊字符
- ``` a|b ``` ：表示匹配a或者b其中的一个
- ```[abcd]```：表示匹配```abcd```中的一个，和 | 功能一样
- ```[^abcd]```：表示不匹配```abcd```中的任何一个
- ```[a-z]```：表示范围，从字符a到字符c，也可以[0-9]等等
- ```\\[``` : 匹配特殊字符[，```\\```表示转义


（2）常用元字符
- ```.``` : 表示任意一个字符
- ```*```：表示前一个字符重复任意次（0到n）
- ```？```：表示前一个字符重复0次或1次
- ```+```： 表示前一个字符重复1次或n次
- ```{n}```: 表示前一个字符重复n次
- ```{n,}```：重复n次以上
- ```{n,m}```:重复n到m次

（3）常用定位符
- ```^``` : 表示文本的开始
- ```$``` ：表示文本的结尾
- ```[[:<:]]``` :表示词的开始
- ```[[:>:]]``` :表示词的结尾

### 1.3.2 处理数据

#### I. 计算字段

检索出的数据经过过滤后，有时候仍需要进一步加工才能够更为方便使用。例如两个字段的值组合成一个新的值进行使用，那么我们将这种表中不存在，最后计算出来的字段称为计算字段。

计算字段的产生通常有两种方式：

- 拼接
- 算术计算

（1） 拼接字段

使用```Concat（）```函数将多个字段值和字面量拼接成一个字段

```sql
SELECT Concat(colu1,':',colu2)
FROM tables
```

（2） 执行算术计算

```sql
SELECT colu1*colu2
FROM tables
```

（3）其他

- 可以使用别名为计算字段设置一个字段名，关键字为AS

```sql
  SELECT colu1*colu2 AS multiply
  FROM tables
```

- 可以使用```LTrim()```和```RTrim()```进行消除空格的操作

#### II. 数据处理函数

`sql`的函数主要对三类数据进行处理

- 处理文本
- 处理数值
- 处理时间

（1） 处理文本

| 函数名                    | 简介                                                         |
| :------------------------ | ------------------------------------------------------------ |
| `Right(str,length)`       | 从最右边取字符串`str`的length位子串                          |
| `Left（str, length）`     | 从最左边取字符串`str`的前length位子串                        |
| `Locate(substr,str,~pos)` | `substr`在`str`中第一次出现的位置，`pos`可选参数，指从哪一位开始搜索，0表示从头开始 |
| `Lower(str)`              | `str`字母小写                                                |
| `Upper(str)`              | `str`字母大写                                                |
| `SubString(str,pos,~len)` | 在`str`中从`pos`位置开始截取子串，`len`为可选参数，表示子串长度，若无则默认到`str`最后 |

（2）处理数值

| 函数名   | 简介           |
| -------- | -------------- |
| `Abs()`  | 绝对值         |
| `Mod()`  | 取余           |
| `Pi()`   | 返回圆周率     |
| `Rand()` | 返回一个随机数 |
| `Sqrt()` | 平方根         |
| `Exp()`  | 指数           |

（3） 处理日期时间

以下表为`MySQL`中常用的日期时间获取函数

| 时间获取函数          | 简介                                                    |
| --------------------- | ------------------------------------------------------- |
| `Now()`               | 获取当前日期和时间，返回`datestr = YYYY-MM-DD HH:MM:SS` |
| `CurDate()`           | 获取当前日期`YYYY-MM-DD`                                |
| `CurTime()`           | 获取当前时间`HH:MM:SS`                                  |
| `Current_timestamp()` | 获取当前时间戳，自动转换成当前时区标准格式的时间        |

以下表`MySQL`中常用的日期时间处理函数

| 时间处理函数                          | 简介                                      |
| ------------------------------------- | ----------------------------------------- |
| `Date(datestr)`                       | `datestr`中的日期部分（`year-month-day`） |
| `Year(datestr) / Month() / Day()`     | `datestr`日期中的年/月/日                 |
| `Time(datestr)`                       | `datestr`中的时间（`hour:minute:second`） |
| `Hour(datestr) / Minute() / Second()` | `datestr`中的时/分/秒                     |

#### III. 汇总函数

| 函数名    | 简介                                                         |
| --------- | ------------------------------------------------------------ |
| `Count()` | 某列的行数                                                   |
| `Avg()`   | 某列的平均数                                                 |
| `Max()`   | 某列的最大值，通常用来查找最大数值或日期，且忽略值为NULL的列 |
| `Min()`   | 某列的最小值                                                 |
| `Sum()`   | 某列值的总和                                                 |



#### IV. 数据分组

**将数据分为几个逻辑分组，然后便于每个组内汇总计算**

```sql
SELECT COUNT(*) 
FROM tables
GROUP BY columns;
```

> **使用`GROUP BY`时，`SELECT`查询的列只能是被分组的列和汇总函数产生的计算字段** 

`GROUP BY`允许跟多个列进行嵌套分组

### 1.3.3 多表查询

#### I. 子查询

在查询中嵌入查询，可以将内嵌的查询的结果作为外层查询的条件或计算字段

（１）将子查询结果作为外层查询的条件

```sql
SELECT *
FROM table1
WHERE　table1.col1 = (SELECT col1 FROM table2 WHERE table2.clo2 = 'clo2');
```

（２）将子查询结果作为外层查询的计算字段

```sql
SELECT col1, col2, (SELECT COUNT(*) FROM table2 WHERE table2.col1 = table1.col1) 
FROM table1;
```

#### II. 联结查询

（１）内联结

（２）外联结

内联结和外联结的主要区别在于：外联结保留某一张表的全部字段，将不满足联结条件的行的内容填充为NULL。



#### III. 组合查询

多个`SELECT`语句查询的并集

```sql
SELECT col1, col2
FROM table1
UNION
SELECT col1, col2
FROM table2
```

- `UNION`中的每个查询必须是相同的列，并且列的类型要兼容
- `UNION`默认取消重复的行，使用`UNION ALL`显示说明包含重复的行
- 对结果排序，只能在最后一个`SELECT`查询里使用`ORDER BY`，不允许多个`ORDER BY`



### 1.3.4 全文本搜索

全文本搜索相对与通配符搜索LIKE和正则搜索来说，速度更快，因为它会对文本建立一个索引，因此也为带来额外的消耗。

#### I. 开启全文本搜索

使用`FULLTEXT()`开启对某列或多列进行全文本搜索，使用`MyISAM`引擎（`innoDB`引擎没有全文本搜索功能）

 ```sql
CREATE table t_table
(
    t_id int,
	t_text text,
	FULLTEXT(t_text)
) ENGINE=MyISAM;

 ```

#### II. 使用全文本搜索 

使用`Match()` 和`Against()`执行全文本搜索

- `Match()`：指定被搜索的列
- `Against()`: 指定要搜索的表达式

```sql
SELECT col_text
FROM tables
WHERE Match(col_text) Against('text');
```

> `Match()　Against()` 会计算一个等级值，根据搜索词在文本中出现的次数、唯一词的数目、整个索引中词的总数以及包含该词的行的数目计算出来，不包含词的等级值为０，最后的搜索结果按照等级值从高到低排列，等级值越高，代表越是期望被搜索到的。

> 由于索引建立比较消耗资源，因此在对数据库导入数据时，不应设置全文本搜索，因为在导入数据时会一直更新索引，会消耗额外时间。当数据导入后，再更改表设置全文本搜索，只更新一次索引，降低资源消耗。

#### III. 全文搜索原理及过程

- 对文本进行分词得到词元
- 对词元转化成词根得到词
- 利用词创建一个字典，一个词对应一个文档编号（行）
- 对字典按字母排序并合并相同的词，得到索引

> 仅限`MYISAM`引擎进行英文搜索



## 1.4 插入数据

### 1.4.1 单行插入

使用`Insert`关键字完成数据的插入，示例如下：

```sql
Insert Into table1(
	col1,
    col2,
    col3
)Values(
	col1_val,
    col2_val,
    col3_val
);
```

### 1.4.2 多行插入

插入多行可以使用多个`Insert`完成，当列相同时，还可以在`Values`后面跟多行值，这样处理比多个`Insert`快。

```sql
Insert Into table1(
	col1,
    col2,
    col3
)Values(
	col1_val,
    col2_val,
    col3_val
),(
	col1_val2,
    col2_val2,
    col3_val2
);
```

### １.4.2



## 1.5 更新与删除数据




# 2 高级特性

## 2.1 事务

保证一段`sql`语句的原子性，即这段`sql`语句要么全部执行，要么全部不执行

开启事务后，将会有两种可能

- `Sql`语句全部执行成功，然后显示提交（Commit）
- `Sql`语句只要有一条执行失败，然后回滚到开启事务的地方（Rollback）

```sql
-- Commit情况
START TRANSACTION;
-- SQL语句
COMMIT;
```

```sql
-- Rollback情况
START TRANSACTION;
--SQL语句
ROLLBACK;
```

为了满足部分回退的需求，可以采用保存点来实现相关功能

```sql
START TRANSACTION;
-- SQL语句
SAVEPOINT sp1;
-- SQL语句
ROLLBACK TO sp1;
```



# 3 管理与维护

## 3.1 安全管理

